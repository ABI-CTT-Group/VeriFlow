# Stage 5 Completion Report – Workflow Execution Engine

**Completion Date**: 2026-01-30  
**Status**: ✅ Complete

---

## Summary

Stage 5 implemented the complete workflow execution engine, enabling CWL workflows to be converted to Airflow DAGs and executed with real-time status updates:

- **CWL Parser**: Parse CWL v1.3 workflow YAML files
- **DAG Generator**: Convert CWL to Airflow DAGs with DockerOperators
- **Airflow Client**: Session-based authentication, DAG triggering, status polling
- **Docker Builder**: Dockerfile management for tool containers
- **Execution Engine**: Integration with Airflow for workflow orchestration

---

## Deliverables

### New Files Created

| File | Description |
|------|-------------|
| `backend/app/models/cwl.py` | Pydantic models for CWL CommandLineTool and Workflow |
| `backend/app/services/cwl_parser.py` | CWL v1.3 parser with step dependency resolution |
| `backend/app/services/dag_generator.py` | CWL→Airflow DAG conversion with DockerOperators |
| `backend/app/services/airflow_client.py` | Airflow REST API client with session auth |
| `backend/app/services/docker_builder.py` | Dockerfile generation and container management |
| `backend/app/services/execution_engine.py` | Orchestrates CWL parsing, DAG generation, and execution |
| `reports/stage5_trigger_airflow.md` | Guide for manually triggering Airflow DAGs |

### Modified Files

| File | Changes |
|------|---------|
| `backend/app/api/executions.py` | Integrated execution engine for real workflow execution |
| `backend/app/services/__init__.py` | Exported new services |
| `dags/` | DAGs are now dynamically generated by the execution engine |

---

## Technical Details

### CWL Parser (`cwl_parser.py`)

```python
class CWLParser:
    def parse_workflow(self, cwl_content: str) -> CWLWorkflow
    def parse_tool(self, cwl_content: str) -> CWLCommandLineTool
    def _resolve_step_dependencies(self, steps: List[CWLWorkflowStep]) -> Dict[str, List[str]]
```

**Features:**
- Parses CWL v1.3 workflow and CommandLineTool documents
- Validates required CWL fields (cwlVersion, class, baseCommand)
- Resolves step dependencies from input sources
- Handles complex input bindings and type definitions

### DAG Generator (`dag_generator.py`)

```python
class DAGGenerator:
    def generate_dag(self, workflow: CWLWorkflow, execution_id: str) -> str
    def _create_docker_operator(self, step: CWLWorkflowStep, dag_name: str) -> str
    def _get_step_order(self, dependencies: Dict[str, List[str]]) -> List[str]
```

**Features:**
- Generates valid Airflow DAG Python code
- Maps CWL steps to DockerOperators
- Configures MinIO volume mounts for input/output
- Topological sorting for correct execution order
- Sets appropriate Catchup=False for manual triggering

### Airflow Client (`airflow_client.py`)

```python
class AirflowClient:
    async def trigger_dag(self, dag_id: str, conf: dict = None) -> str
    async def get_dag_run_status(self, dag_id: str, dag_run_id: str) -> dict
    async def get_task_instances(self, dag_id: str, dag_run_id: str) -> List[dict]
    async def get_task_logs(self, dag_id: str, dag_run_id: str, task_id: str) -> str
```

**Features:**
- Session-based authentication (username/password)
- Async HTTP client using httpx
- DAG triggering with configuration payload
- Status polling for DAG runs and task instances
- Log retrieval for debugging

### Docker Builder (`docker_builder.py`)

```python
class DockerBuilder:
    def generate_dockerfile(self, tool: CWLCommandLineTool) -> str
    def get_base_image(self, requirements: dict) -> str
```

**Features:**
- Generates Dockerfiles from CWL tool requirements
- Selects appropriate base images (Python, R, etc.)
- Placeholder for registry push (MVP simplification)

### Execution Engine (`execution_engine.py`)

```python
class ExecutionEngine:
    async def execute_workflow(
        self, workflow_id: str, cwl_content: str, inputs: dict
    ) -> ExecutionResult
    async def get_execution_status(self, execution_id: str) -> ExecutionStatus
    async def poll_execution(self, execution_id: str) -> AsyncGenerator[ExecutionStatus, None]
```

**Features:**
- Orchestrates complete workflow execution pipeline
- Stores DAG files in Airflow DAGs folder
- Manages execution lifecycle (pending → running → completed/failed)
- Provides async generator for real-time status updates
- Integrates with MinIO for input/output storage

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Execution Flow                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. POST /api/executions                                            │
│     └─► ExecutionEngine.execute_workflow()                          │
│                                                                      │
│  2. CWL Parser                                                      │
│     └─► Parse CWL YAML → CWLWorkflow object                         │
│                                                                      │
│  3. DAG Generator                                                   │
│     └─► CWLWorkflow → Airflow DAG Python file                       │
│                                                                      │
│  4. Airflow Client                                                  │
│     └─► Trigger DAG → Poll status → Retrieve logs                   │
│                                                                      │
│  5. WebSocket                                                       │
│     └─► Stream status updates to frontend                           │
│                                                                      │
│  6. MinIO Storage                                                   │
│     └─► Store inputs/outputs in process bucket                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Verification

### AI Tasks Verification

| Task | Status | Evidence |
|------|--------|----------|
| CWL v1.3 parsing | ✅ | Parser handles workflow and tool documents |
| CommandLineTool → DockerOperator | ✅ | DAG generator creates DockerOperator code |
| Step dependencies | ✅ | Topological sort ensures correct order |
| MinIO mounts | ✅ | Volume configuration in DockerOperator |
| Session auth | ✅ | Airflow client authenticates via session |
| DAG trigger | ✅ | trigger_dag() calls Airflow REST API |
| Status polling | ✅ | get_dag_run_status() with 5s interval |
| Log retrieval | ✅ | get_task_logs() fetches task output |
| Dockerfile generation | ✅ | docker_builder creates Dockerfiles |
| WebSocket streaming | ✅ | executions.py streams status updates |
| MinIO results storage | ✅ | Process bucket stores execution outputs |
| Provenance linking | ✅ | wasDerivedFrom tracked in execution metadata |

### Developer Tasks Verification

| Task | Status | Evidence |
|------|--------|----------|
| DAGs appear in Airflow UI | ✅ | Verified at http://localhost:8080 |
| Manual DAG trigger works | ✅ | Sample DAG executed successfully |

---

## Exit Criteria Status

| Criterion | Status |
|-----------|--------|
| CWL→Airflow conversion working | ✅ |
| Docker execution verified | ✅ |
| All AI Tasks complete | ✅ |
| All Developer Tasks complete | ✅ |

---

## Notes

1. **MVP Simplification**: Docker registry push is a placeholder - images are assumed pre-built
2. **DAG Storage**: DAGs written directly to mounted `/dags` folder
3. **Authentication**: Using Airflow default credentials (airflow/airflow)
4. **Polling Interval**: 5-second status polling as per SPEC.md

---

## Next Stage

Stage 6: End-to-End Integration
- Integrate all components for MAMA-MIA demo flow
- Implement error handling for all failure modes
- Add console logging for all operations
- Implement SDS export functionality
