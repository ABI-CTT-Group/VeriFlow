%% VeriFlow - System Architecture
%% Gemini 3 Hackathon Submission
%% Highlights ALL Gemini 3 integration points

%% ============================================================
%% Diagram 1: System Infrastructure Overview
%% ============================================================
---
title: "VeriFlow System Infrastructure"
---
graph TB
    subgraph Frontend["Vue 3 Frontend :3000"]
        UI[App.vue<br/>4-Panel Layout]
        WF[WorkflowAssemblerModule<br/>Vue Flow Graph]
        SD[StudyDesignModule<br/>ISA Hierarchy Viewer]
        UP[UploadModule<br/>PDF Upload + Demo]
        DS[DatasetNavigationModule<br/>Results & Export]
        CS[ConsoleModule<br/>Real-time Logs]
    end

    subgraph Backend["FastAPI Backend :8000"]
        API[REST API<br/>5 Routers]
        subgraph Agents["Gemini 3 AI Agents"]
            SA["ScholarAgent<br/>gemini-3-pro-preview<br/>Thinking: HIGH 24576"]
            EA["EngineerAgent<br/>gemini-3-pro-preview<br/>Thinking: HIGH 24576"]
            RA["ReviewerAgent<br/>gemini-3-flash-preview<br/>Thinking: MEDIUM 8192"]
        end
        GC["GeminiClient<br/>google-genai SDK"]
        subgraph Services["Core Services"]
            CWP[CWLParser]
            DAG[DAGGenerator]
            DB[DockerBuilder]
            EE[ExecutionEngine]
            SDS[SDSExporter]
        end
        PM[PromptManager<br/>prompts.yaml]
        CFG[AppConfig<br/>config.yaml]
    end

    subgraph Storage["Data Layer"]
        PG[(PostgreSQL 15<br/>:5432)]
        MN[(MinIO S3<br/>:9000)]
    end

    subgraph Execution["Workflow Execution"]
        AF[Airflow 3.0.6<br/>API Server :8080]
        AS[Airflow Scheduler]
        DIND[Docker-in-Docker]
        CWL[CWL Runner<br/>cwltool]
    end

    subgraph Gemini["Gemini 3 API"]
        G3["Google Gemini 3<br/>Pro + Flash"]
    end

    Frontend -->|axios /api/v1| API
    API --> SA & EA & RA
    SA & EA & RA --> GC
    GC -->|google-genai SDK| G3
    API --> Services
    EE --> CWP & DAG & DB
    EE -->|Trigger DAG| AF
    AF --> AS
    AS -->|DockerOperator| DIND
    DIND --> CWL
    API --> PG & MN
    EE --> MN

    classDef gemini fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef agent fill:#EA4335,stroke:#c5221f,color:#fff
    classDef frontend fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef storage fill:#FBBC04,stroke:#f9ab00,color:#333
    classDef execution fill:#9334E6,stroke:#7627bb,color:#fff

    class G3 gemini
    class SA,EA,RA,GC agent
    class UI,WF,SD,UP,DS,CS frontend
    class PG,MN storage
    class AF,AS,DIND,CWL execution


%% ============================================================
%% Diagram 2: Gemini 3 Integration Points (DETAILED)
%% ============================================================
---
title: "Gemini 3 Feature Integration Map"
---
graph LR
    subgraph Features["Gemini 3 Features Used"]
        F1["Pydantic Structured Output<br/>response_schema parameter"]
        F2["Thinking Level Control<br/>ThinkingConfig + budget"]
        F3["Grounding with Google Search<br/>GoogleSearch tool"]
        F4["Native PDF Upload<br/>client.files.upload()"]
        F5["Thought Signature Preservation<br/>Multi-turn reasoning chains"]
        F6["Agentic Vision<br/>Page image extraction"]
        F7["Agentic Function Calling<br/>Think-Act-Observe loops"]
    end

    subgraph Schemas["Pydantic Output Schemas"]
        S1[AnalysisResult<br/>Scholar Agent]
        S2[WorkflowResult<br/>Engineer Agent]
        S3[ValidationResult<br/>Reviewer Agent]
        S4[ErrorTranslationResult<br/>Reviewer Agent]
    end

    subgraph Agents["Agent Usage"]
        SA[ScholarAgent<br/>analyze_publication<br/>analyze_with_vision]
        EA[EngineerAgent<br/>generate_workflow<br/>generate_workflow_agentic]
        RA[ReviewerAgent<br/>validate_workflow<br/>validate_and_fix<br/>translate_errors]
    end

    F1 -->|AnalysisResult| SA
    F1 -->|WorkflowResult| EA
    F1 -->|ValidationResult| RA
    F1 -->|ErrorTranslationResult| RA
    F2 -->|HIGH 24576| SA
    F2 -->|HIGH 24576| EA
    F2 -->|MEDIUM 8192| RA
    F2 -->|LOW 2048| RA
    F3 -->|Tool verification| SA
    F4 -->|PDF analysis| SA
    F5 -->|Iterative generation| EA
    F5 -->|Iterative validation| RA
    F6 -->|Diagram extraction| SA
    F7 -->|CWL validate loop| EA

    classDef feature fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef schema fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef agent fill:#EA4335,stroke:#c5221f,color:#fff

    class F1,F2,F3,F4,F5,F6,F7 feature
    class S1,S2,S3,S4 schema
    class SA,EA,RA agent


%% ============================================================
%% Diagram 3: Data Flow Pipeline
%% ============================================================
---
title: "VeriFlow Data Flow Pipeline"
---
graph LR
    PDF["Scientific<br/>Publication<br/>(PDF)"] -->|Upload| UP[UploadModule]
    UP -->|MinIO storage<br/>+ temp file| SA[ScholarAgent]
    SA -->|Gemini 3 Pro<br/>+ Grounding<br/>+ PDF Upload<br/>+ Structured Output| ISA[ISA-JSON<br/>Hierarchy]
    ISA -->|User selects assay| EA[EngineerAgent]
    EA -->|Gemini 3 Pro<br/>+ Structured Output<br/>+ Thinking HIGH| WF[CWL Workflow<br/>+ Dockerfiles<br/>+ Vue Flow Graph]
    WF -->|Validate| RA[ReviewerAgent]
    RA -->|Gemini 3 Flash<br/>+ Structured Output<br/>+ Thought Signatures| VAL{Valid?}
    VAL -->|Yes| EXE[ExecutionEngine]
    VAL -->|No - Auto Fix| RA
    EXE -->|CWL Parser<br/>DAG Generator| AF[Airflow 3.0.6]
    AF -->|DockerOperator| DIND[Docker-in-Docker]
    DIND -->|cwltool| RES[Results]
    RES -->|SDS Exporter| ZIP[SDS ZIP<br/>dataset_description.json<br/>manifest.xlsx<br/>provenance.json]

    classDef gemini fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef agent fill:#EA4335,stroke:#c5221f,color:#fff
    classDef data fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef execution fill:#9334E6,stroke:#7627bb,color:#fff

    class SA,EA,RA agent
    class ISA,WF,RES,ZIP data
    class AF,DIND,EXE execution


%% ============================================================
%% Diagram 4: GeminiClient Architecture
%% ============================================================
---
title: "GeminiClient - google-genai SDK Integration"
---
graph TB
    subgraph GeminiClient["GeminiClient (gemini_client.py)"]
        INIT["__init__<br/>genai.Client(api_key)"]
        BC["_build_generation_config<br/>GenerateContentConfig"]

        subgraph Methods["3 Core Methods"]
            AF["analyze_file()<br/>PDF Upload + Analysis"]
            GT["generate_text()<br/>Text Generation"]
            GH["generate_with_history()<br/>Multi-turn + Thought Sigs"]
        end

        subgraph Config["Gemini 3 Config Builder"]
            SO["response_schema<br/>Pydantic Model"]
            TC["thinking_config<br/>ThinkingConfig(budget)"]
            GR["tools<br/>GoogleSearch()"]
            SI["system_instruction"]
        end
    end

    subgraph SDK["google-genai SDK"]
        CL["genai.Client"]
        FU["client.files.upload()"]
        GC["client.models.generate_content()"]
        TP["types.GenerateContentConfig"]
        TK["types.ThinkingConfig"]
        GS["types.GoogleSearch"]
        PT["types.Part(thought=True)"]
    end

    AF -->|Upload PDF| FU
    AF & GT & GH -->|Generate| GC
    BC --> SO & TC & GR & SI
    BC --> TP
    TC --> TK
    GR --> GS
    GH -->|Preserve thoughts| PT

    classDef method fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef sdk fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef config fill:#FBBC04,stroke:#f9ab00,color:#333

    class AF,GT,GH method
    class CL,FU,GC,TP,TK,GS,PT sdk
    class SO,TC,GR,SI config


%% ============================================================
%% Diagram 5: Frontend Component Architecture
%% ============================================================
---
title: "Frontend Component Architecture"
---
graph TB
    subgraph App["App.vue - Main Layout"]
        LP[LandingPageOverlay]
        HD[Header + ConfigurationPanel]

        subgraph LeftPanels["Left Panels"]
            UM[UploadModule<br/>PDF Upload + Demo Load]
            SDM[StudyDesignModule<br/>ISA Tree + Assay Select]
        end

        subgraph Center["Center Panel"]
            WAM[WorkflowAssemblerModule]
            subgraph VueFlow["Vue Flow Canvas"]
                GN[GraphNode<br/>Custom Nodes]
                CL[ConnectionLine<br/>Custom Edges]
            end
            VP[ViewerPanel<br/>PDF Viewer]
            DOC[DataObjectCatalogue<br/>Tools/Models/Data]
        end

        subgraph RightPanel["Right Panel"]
            DNM[DatasetNavigationModule<br/>Results + Export]
            FTN[FileTreeNode<br/>SDS Structure]
        end

        subgraph Bottom["Bottom Panel"]
            CM[ConsoleModule<br/>Log Stream]
            CI[ConsoleInput]
        end
    end

    subgraph StateLayer["State Management"]
        WS[workflowStore<br/>Pinia]
        CST[consoleStore<br/>Pinia]
    end

    subgraph APILayer["API Layer"]
        AX[api.ts<br/>axios /api/v1]
    end

    UM & SDM & WAM & DNM --> WS
    CM --> CST
    WS & CST --> AX

    classDef layout fill:#f0f0f0,stroke:#666,color:#333
    classDef component fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef state fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef api fill:#EA4335,stroke:#c5221f,color:#fff

    class UM,SDM,WAM,GN,CL,VP,DOC,DNM,FTN,CM,CI,LP,HD component
    class WS,CST state
    class AX api


%% ============================================================
%% Diagram 6: Docker Compose Services
%% ============================================================
---
title: "Docker Compose - 9 Services"
---
graph TB
    subgraph DockerCompose["docker-compose.yml"]
        subgraph AppLayer["Application Layer"]
            BE["backend<br/>FastAPI :8000<br/>Python 3.11"]
            FE["frontend<br/>Vue 3 + Nginx :3000"]
        end

        subgraph DataLayer["Data Layer"]
            PG["postgres<br/>PostgreSQL 15 :5432"]
            MN["minio<br/>MinIO S3 :9000/:9001"]
            MI["minio-init<br/>Bucket Setup (ephemeral)"]
        end

        subgraph AirflowLayer["Airflow Layer"]
            AA["airflow-apiserver<br/>Airflow 3.0.6 :8080"]
            AAS["airflow-scheduler<br/>LocalExecutor"]
        end

        subgraph CWLLayer["CWL Execution Layer"]
            DI["dind<br/>Docker-in-Docker"]
            CW["cwl<br/>cwltool Runner"]
        end
    end

    FE -->|HTTP| BE
    BE -->|asyncpg| PG
    BE -->|minio SDK| MN
    MI -->|mc alias set| MN
    BE -->|httpx| AA
    AA --> AAS
    AAS -->|DockerOperator| DI
    DI --> CW
    AA -->|SQL| PG

    subgraph Volumes["Named Volumes"]
        V1[postgres-data]
        V2[minio-data]
        V3[airflow-logs]
        V4[cwl-output]
        V5[cwl-tmp]
    end

    subgraph Network["veriflow-network (bridge)"]
    end

    classDef app fill:#34A853,stroke:#1e8e3e,color:#fff
    classDef data fill:#FBBC04,stroke:#f9ab00,color:#333
    classDef airflow fill:#9334E6,stroke:#7627bb,color:#fff
    classDef cwl fill:#EA4335,stroke:#c5221f,color:#fff

    class BE,FE app
    class PG,MN,MI data
    class AA,AAS airflow
    class DI,CW cwl


%% ============================================================
%% Diagram 7: Sequence - Upload to Execution
%% ============================================================
---
title: "End-to-End Sequence: Upload to Execution"
---
sequenceDiagram
    actor User
    participant FE as Vue Frontend
    participant API as FastAPI
    participant Scholar as ScholarAgent
    participant Gemini as Gemini 3 API
    participant Engineer as EngineerAgent
    participant Reviewer as ReviewerAgent
    participant Engine as ExecutionEngine
    participant Airflow as Airflow 3.0.6
    participant DinD as Docker-in-Docker

    User->>FE: Upload PDF
    FE->>API: POST /publications/upload
    API->>API: Store in MinIO
    API-->>FE: upload_id (processing)

    Note over API,Gemini: Background Task
    API->>Scholar: analyze_publication()
    Scholar->>Gemini: client.files.upload() [PDF]
    Scholar->>Gemini: generate_content()<br/>response_schema=AnalysisResult<br/>thinking_budget=24576<br/>google_search=True
    Gemini-->>Scholar: Structured ISA-JSON
    Scholar-->>API: AnalysisResult

    FE->>API: GET /study-design/{id}
    API-->>FE: ISA Hierarchy + Confidence Scores

    User->>FE: Select Assay
    FE->>API: POST /workflows/assemble
    API->>Engineer: generate_workflow()
    Engineer->>Gemini: generate_content()<br/>response_schema=WorkflowResult<br/>thinking_budget=24576
    Gemini-->>Engineer: CWL + Graph + Dockerfiles
    API->>Reviewer: validate_workflow()
    Reviewer->>Gemini: generate_content()<br/>response_schema=ValidationResult<br/>thinking_budget=8192
    Gemini-->>Reviewer: Validation Result
    API-->>FE: Workflow Graph + Validation

    User->>FE: Run Workflow
    FE->>API: POST /executions
    API->>Engine: prepare_execution()
    Engine->>Engine: CWL Parse + DAG Generate
    Engine->>Airflow: Trigger DAG
    Airflow->>DinD: DockerOperator
    DinD->>DinD: cwltool execute

    loop Status Polling
        FE->>API: GET /executions/{id}
        API-->>FE: Progress + Node Status
    end

    API-->>FE: Execution Complete
    User->>FE: Export Results
    FE->>API: GET /executions/{id}/export
    API-->>FE: SDS ZIP Download


%% ============================================================
%% Diagram 8: Thinking Budget Allocation
%% ============================================================
---
title: "Gemini 3 Thinking Budget Allocation"
---
graph LR
    subgraph ThinkingBudgets["Thinking Budget Strategy"]
        H["HIGH<br/>24,576 tokens"]
        M["MEDIUM<br/>8,192 tokens"]
        L["LOW<br/>2,048 tokens"]
    end

    subgraph HighTasks["Complex Scientific Reasoning"]
        H1[Scholar: PDF Analysis<br/>ISA Extraction]
        H2[Engineer: CWL Generation<br/>Dockerfile Creation]
        H3[Engineer: Agentic Loop<br/>Validate-Fix-Regenerate]
    end

    subgraph MedTasks["Validation & Checking"]
        M1[Reviewer: Semantic Validation<br/>Type Compatibility]
        M2[Reviewer: Iterative Fix<br/>Thought Signature Chain]
    end

    subgraph LowTasks["Simple Translation"]
        L1[Reviewer: Error Translation<br/>User-friendly Messages]
    end

    H --> H1 & H2 & H3
    M --> M1 & M2
    L --> L1

    classDef high fill:#EA4335,stroke:#c5221f,color:#fff
    classDef medium fill:#FBBC04,stroke:#f9ab00,color:#333
    classDef low fill:#34A853,stroke:#1e8e3e,color:#fff

    class H,H1,H2,H3 high
    class M,M1,M2 medium
    class L,L1 low
