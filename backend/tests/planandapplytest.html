<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriFlow: Human-in-the-Loop Workbench</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --success: #22c55e; --error: #ef4444; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #334155; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; min-height: 0; }
        .card { background: var(--panel); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #334155; min-height: 0; }
        
        /* Components */
        h2 { margin: 0; font-size: 1.2rem; color: var(--accent); }
        label { font-size: 0.9rem; color: #94a3b8; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
        button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #475569; cursor: not-allowed; }
        button.secondary { background: #334155; }
        button.apply { background: var(--success); }
        
        /* Logs Area */
        #logs { flex: 1; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; background: #0b1120; padding: 10px; border-radius: 4px; }
        .log-entry { margin-bottom: 5px; border-left: 3px solid transparent; padding-left: 8px; }
        .log-info { color: #94a3b8; }
        .log-agent { color: var(--accent); border-left-color: var(--accent); }
        .log-success { color: var(--success); }
        .log-error { color: var(--error); }
        
        /* Chat Area */
        .chat-history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; }
        .msg { padding: 10px; border-radius: 6px; max-width: 85%; font-size: 0.9rem; }
        .msg.user { background: #3b82f630; align-self: flex-end; border: 1px solid #3b82f6; }
        .msg.agent { background: #334155; align-self: flex-start; }
        .msg-header { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; font-weight: bold; }
        
        /* Status Badges */
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; background: #475569; }
        .status-running { background: #eab308; color: black; }
        .status-completed { background: var(--success); color: black; }
        
        /* Tab toggle */
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .tab { padding: 5px 10px; cursor: pointer; border-radius: 4px; color: #94a3b8; }
        .tab.active { background: #334155; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <h1>VeriFlow <span style="font-weight:normal; font-size:0.6em; opacity:0.7;">Dev Console</span></h1>
            <span id="connectionStatus" class="status-badge">Disconnected</span>
        </div>
        <div>
            <span id="runIdDisplay" style="font-family:monospace; color:var(--accent);">No Run Active</span>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>1. Configuration</h2>
            <div>
                <label>PDF Path (Local)</label>
                <input type="text" id="pdfPath" value="VeriFlow/backend/tests/mamamiaworkflow.pdf">
            </div>
            <div>
                <label>Repository Path (Local)</label>
                <input type="text" id="repoPath" value="VeriFlow/backend/examples/mama-mia">
            </div>
            <div>
                <label>Initial User Context</label>
                <textarea id="userContext" rows="2" placeholder="E.g., 'Use Python 3.9 specifically...'">The workflow should run on CPU only</textarea>
            </div>
            <button onclick="startWorkflow()" id="startBtn">▶ Start New Workflow</button>
            
            <h2 style="margin-top:20px; border-top:1px solid #334155; padding-top:20px;">Live Execution Logs</h2>
            <div id="logs">
                <div class="log-info">Waiting for start...</div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')" id="tab-chat">Intervention (Chat)</div>
                <div class="tab" onclick="switchTab('restart')" id="tab-restart">Manual Restart</div>
            </div>

            <div id="view-chat" style="display:flex; flex-direction:column; flex:1; min-height:0;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="agentSelect" onchange="clearChatUI()">
                        <option value="scholar">Scholar Agent</option>
                        <option value="engineer" selected>Engineer Agent</option>
                        <option value="reviewer">Reviewer Agent</option>
                    </select>
                </div>

                <div class="chat-history" id="chatHistory">
                    <div class="log-info" style="text-align:center; margin-top:20px;">
                        Select an agent to discuss the current run.<br>
                        Specify changes, then click "Apply & Restart".
                    </div>
                </div>

                <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
                    <textarea id="chatInput" rows="3" placeholder="Critique the output or give new instructions..."></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="secondary" onclick="sendChatMessage()" style="flex:1;">Send Message</button>
                        <button class="apply" onclick="applyAndRestart()" style="flex:1;">⚡ Apply & Restart</button>
                    </div>
                </div>
            </div>

            <div id="view-restart" style="display:none; flex-direction:column; gap:15px;">
                <p style="color:#94a3b8; font-size:0.9rem;">
                    Force the workflow to restart from a specific node without changing directives.
                    Useful for retrying transient errors.
                </p>
                <div>
                    <label>Restart From Node:</label>
                    <select id="restartNodeSelect">
                        <option value="scholar">Scholar (Full Restart)</option>
                        <option value="engineer" selected>Engineer (Regenerate Code)</option>
                        <option value="reviewer">Reviewer (Re-evaluate)</option>
                    </select>
                </div>
                <button class="secondary" onclick="manualRestart()">Restart Workflow</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE = 'http://localhost:8000/api/v1';
        const WS_BASE = 'ws://localhost:8000/ws';
        const clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        
        let currentRunId = null;
        let ws = null;

        // --- Initialization ---
        function init() {
            connectWebSocket();
            
            // Auto-fill paths if running in typical dev environment structure
            // Users will likely need to adjust these in the UI
            console.log("Client ID:", clientId);
        }

        // --- WebSocket ---
        function connectWebSocket() {
            ws = new WebSocket(`${WS_BASE}/${clientId}`);
            const statusEl = document.getElementById('connectionStatus');

            ws.onopen = () => {
                statusEl.innerText = "Connected";
                statusEl.classList.add('status-completed');
                statusEl.style.background = '#22c55e';
            };

            ws.onclose = () => {
                statusEl.innerText = "Disconnected";
                statusEl.style.background = '#ef4444';
                setTimeout(connectWebSocket, 3000); // Reconnect
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWsMessage(data);
            };
        }

        function handleWsMessage(msg) {
            const logs = document.getElementById('logs');
            const type = msg.type;
            const content = msg.message || msg.chunk || JSON.stringify(msg);
            
            let div = document.createElement('div');
            div.className = 'log-entry';

            if (type === 'agent_stream') {
                // For streams, append to last element if it's the same agent, or create new
                // Simplified: just log chunk for now
                div.innerHTML = `<span style="color:#3b82f6">[${msg.agent}]</span> ${msg.chunk}`;
            } else if (type === 'status_update') {
                div.innerHTML = `<span style="color:#eab308">[STATUS]</span> ${msg.message}`;
            } else if (type.includes('complete')) {
                div.innerHTML = `<span style="color:#22c55e">[DONE]</span> ${type.toUpperCase()} - Run ID: ${msg.data?.run_id}`;
                if (msg.data?.run_id) currentRunId = msg.data.run_id;
            } else if (type === 'error') {
                div.innerHTML = `<span style="color:#ef4444">[ERROR]</span> ${msg.data}`;
            } else {
                div.innerText = JSON.stringify(msg);
            }

            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        // --- Actions ---

        async function startWorkflow() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            appendLog('System', 'Initiating new workflow...');

            const payload = {
                pdf_path: document.getElementById('pdfPath').value,
                repo_path: document.getElementById('repoPath').value,
                user_context: document.getElementById('userContext').value,
                client_id: clientId
            };

            try {
                const res = await fetch(`${API_BASE}/orchestrate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                currentRunId = data.result.run_id;
                document.getElementById('runIdDisplay').innerText = currentRunId;
                appendLog('System', `Run started: ${currentRunId}`);
                
            } catch (e) {
                appendLog('Error', e.message, true);
            } finally {
                btn.disabled = false;
            }
        }

        async function sendChatMessage() {
            if (!currentRunId) return alert("No active run. Start a workflow first.");
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const agent = document.getElementById('agentSelect').value;
            
            // Add User Message to UI
            addChatBubble('User', message, 'user');
            input.value = '';

            try {
                const res = await fetch(`${API_BASE}/chat/${currentRunId}/${agent}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: message }]
                    })
                });
                
                const data = await res.json();
                // Add Agent Reply
                addChatBubble(agent.toUpperCase(), data.reply, 'agent');
                
            } catch (e) {
                addChatBubble('System', 'Error sending message: ' + e.message, 'agent');
            }
        }

        async function applyAndRestart() {
            if (!currentRunId) return alert("No active run.");
            
            const agent = document.getElementById('agentSelect').value;
            // In a real app, we might summarize the chat history into a directive.
            // Here we assume the user types the *Final Directive* into the chat box 
            // OR we just take the last thing they said. 
            // For better UX, let's ask for the specific directive to apply.
            
            const directive = prompt(`Enter the specific instruction to apply to ${agent}:`, "Fix the issue discussed.");
            if (!directive) return;

            appendLog('System', `Applying directive to ${agent} and restarting...`);

            try {
                const res = await fetch(`${API_BASE}/chat/${currentRunId}/${agent}/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ directive: directive })
                });

                const data = await res.json();
                appendLog('System', data.message);
                
            } catch (e) {
                appendLog('Error', e.message, true);
            }
        }

        async function manualRestart() {
            if (!currentRunId) return alert("No active run.");
            const node = document.getElementById('restartNodeSelect').value;
            
            appendLog('System', `Manual restart requested from: ${node}`);
            
            try {
                const res = await fetch(`${API_BASE}/workflows/${currentRunId}/restart?start_node=${node}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                appendLog('System', data.message);
            } catch (e) {
                appendLog('Error', e.message, true);
            }
        }

        // --- UI Helpers ---

        function appendLog(source, text, isError = false) {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span style="color:${isError ? '#ef4444' : '#94a3b8'}">[${source}]</span> ${text}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function addChatBubble(name, text, type) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<div class="msg-header">${name}</div>${text.replace(/\n/g, '<br>')}`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function clearChatUI() {
            document.getElementById('chatHistory').innerHTML = '<div class="log-info" style="text-align:center; margin-top:20px;">Switched Agent context. Previous chat hidden.</div>';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.getElementById('view-chat').style.display = tabName === 'chat' ? 'flex' : 'none';
            document.getElementById('view-restart').style.display = tabName === 'restart' ? 'flex' : 'none';
        }

        // Run
        init();
    </script>
</body>
</html>