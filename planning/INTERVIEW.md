# VeriFlow SPEC.md Interview

**Date**: January 28-29, 2026  
**Interviewer**: AI Senior Engineer + Product Architect  
**Goal**: Produce a production-grade SPEC.md for engineers and AI agents

---

## Status Key
- [ ] Unanswered
- [~] Partially answered (needs follow-up)
- [x] Fully answered

---

## Batch 1: Data Structures & API Contracts

### Q1. SDS Manifest Schema
- [x] What is the **exact JSON schema** for an SDS manifest file?
- [x] Which fields are **required vs optional**?
- [x] What is the **exact format** for provenance links (`wasDerivedFrom`, Tool linking)?

**Answer:**
> Physical format: Excel spreadsheet (`manifest.xlsx`). Backend Agent (via `sds-converter` skill) enforces schema and handles MIME-typing.
> 
> **JSON Schema (Row Level):**
> ```json
> {
>   "filename": "string (required) - Relative path from dataset root",
>   "timestamp": "date-time (required) - Auto-generated by file system",
>   "description": "string (required) - Defaults to 'Data file' if not provided",
>   "file type": "string (optional) - Broad category (text, image)",
>   "additional type": "string (computed) - IANA MIME type, auto-detected by Agent using mimetypes library"
> }
> ```

---

### Q2. CWL Version & Tool Type
- [x] What **CWL version** are you targeting (v1.0, v1.1, v1.2)?
- [x] Should Tools be described as `CommandLineTool` or `ExpressionTool`?
- [x] How are **input/output types** mapped from SPARC ontology to CWL types?

**Answer:**
> **CWL v1.3**. CWL defines "Processes" with four types:
> - CommandLineTool
> - ExpressionTool  
> - Workflow
> - Operation
> 
> See: https://www.commonwl.org/user_guide/

---

### Q3. ISA Extraction Output
- [x] What is the **exact data structure** returned by the Scholar Agent after parsing a PDF?
- [x] How is the `Investigation → Study → Assay` hierarchy serialized (JSON schema)?
- [x] How are **confidence scores** represented (0-1 float? percentage? categorical)?

**Answer:**
> Use **ISA-JSON** for serialization. Confidence scores represented as **percentage** (0-100).

---

### Q4. Workflow Graph State
- [x] What is the **graph data structure** for the workflow canvas (React Flow, custom adjacency list)?
- [x] How are **node positions** stored and persisted?
- [x] What is the **connection validation logic** between nodes (type constraints)?

**Answer:**
> Internally, workflows are described in **CWL** which defines relationships between tools and inputs (models, measurements). When run, automatically converted to Airflow DAGs. Workflows serialized when exported in an SDS dataset.

---

## Batch 2: Agent Boundaries & Error Handling

### Q5. Agent Invocation Protocol
- [x] How are the three agents (Scholar, Engineer, Reviewer) **invoked**?
- [x] Are agents **stateless** or do they maintain **session state**?
- [x] What is the **handoff mechanism** between agents?

**Answer:**
> **Direct Gemini API calls**. Agents should **always maintain session state**.

---

### Q6. Error Recovery Strategies
- [x] If **Scholar Agent fails** to extract ISA from a PDF, what happens?
- [x] If **Docker build fails** (Engineer Agent), what is the fallback?
- [x] If **Airflow DAG execution fails** mid-workflow, can users resume?

**Answer:**
> If Scholar fails, the **Reviewer Agent communicates with user** to indicate issues, suggest mitigation strategies, and/or ask additional questions.

---

### Q7. Reviewer Validation Rules
- [x] What are the **specific validation checks** the Reviewer performs?
- [x] How does it detect MIME-type mismatches?
- [x] What is the **threshold** for flagging incompatibility vs auto-generating an adapter?

**Answer:**
> Validation checks include (but not limited to):
> - Syntax check for CWL contents
> - Syntax check for Airflow DAG
> - Data format check for input data
> - Dependency check
> 
> **All validations must pass**. Otherwise, system automatically generates a fix/adapter, or asks user for additional information until validations pass or user decides not to proceed.

---

## Batch 3: Execution & Runtime Behavior

### Q8. Airflow Integration
- [x] Is Airflow running as a **local container** or a **remote cluster**?
- [x] How does VeriFlow **authenticate** with the Airflow API?
- [x] What is the **polling interval** for job status updates?
- [x] How are **Airflow DAG IDs** generated?

**Answer:**
> - **Airflow 3 runs locally** with VeriFlow on same server/machine
> - **Token-based (JWT) authentication**
> - Polling interval: Use default from Airflow or choose appropriate value

---

### Q9. Subject Iteration Logic
- [x] "Running each tool for each subject"—is this **parallel** or **sequential**?
- [x] How does the system handle **partial subject failures**?
- [x] Is there a **maximum subject limit** for MVP?

**Answer:**
> **Default subject limit: 1** for MVP.

---

### Q10. CWL-to-Airflow Conversion
- [x] What is the **exact mapping** between CWL constructs and Airflow operators?
- [x] How are CWL `scatter` operations translated?
- [x] What CWL features are **not supported** in the MVP conversion?

**Answer:**
> Should support as many CWL features as possible.

---

## Batch 4: Frontend-Backend Contract

### Q11. API Endpoints
- [x] What endpoints does the backend expose?

**Answer:**
> See **planning/api.md** for full specification. Key endpoints:
> 
> **Publication & Study Design:**
> - `POST /api/v1/publications/upload` - Upload PDF
> - `GET /api/v1/study-design/{upload_id}` - Get ISA hierarchy
> - `PUT /api/v1/study-design/nodes/{node_id}/properties` - Update node
> 
> **Workflow Management:**
> - `POST /api/v1/workflows/assemble` - Generate workflow from assay
> - `GET /api/v1/workflows/{workflow_id}` - Get workflow
> - `PUT /api/v1/workflows/{workflow_id}` - Save workflow
> 
> **Catalogue:**
> - `GET /api/v1/catalogue` - List data objects
> - `PUT /api/v1/catalogue/{item_id}` - Update item
> 
> **Execution:**
> - `POST /api/v1/executions` - Run workflow
> - `GET /api/v1/executions/{execution_id}` - Get status
> - `GET /api/v1/executions/{execution_id}/results` - Get results
> 
> **Viewers:**
> - `GET /api/v1/sources/{source_id}` - Get citation snippet

---

### Q12. Real-time Updates
- [x] For console logs and node status updates: **WebSocket** or **HTTP polling**?
- [x] If WebSocket, what is the **message format**?

**Answer:**
> Use **WebSocket** for real-time console logs. Message format: **JSON**.

---

### Q13. File Storage
- [x] Where are uploaded PDFs and generated SDS datasets stored?
- [x] How are **subject data files** accessed by Airflow workers?

**Answer:**
> All SDS datasets stored in **MinIO**. Airflow workers access subject data by its **public URL**.

---

## Batch 5: Edge Cases & MVP Scope

### Q14. Ambiguous Paper Handling
- [x] What happens if a PDF contains **multiple Studies**?
- [x] What if the paper references a **private/paywalled repository**?
- [x] What if the paper's methodology is **too vague**?

**Answer:**
> Include all detected study designs and **let user select which assay** to use.
> 
> For hackathon: Build in **MAMA-MIA paper** as a pre-loaded example. Allow user to either upload a paper OR select from example. This provides constraints to ensure working hackathon demo.

---

### Q15. MVP Scope Boundaries
- [x] Is MAMA-MIA the **only** workflow that must work for MVP?
- [x] Are adapters **pre-built** or **generated on-the-fly**?
- [x] Is "Subject Limiting" required for MVP?

**Answer:**
> - Initially **MAMA-MIA only**
> - Nice to have: **Biv-me** as second pre-loaded example
> - Subject limit: Default to 1 for MVP

---

### Q16. Data Persistence & Export
- [x] Can users **save/resume** partially-configured workflows?
- [x] What is the **exact format** of exported SDS datasets?
- [x] Is there a "project" or "workspace" concept?

**Answer:**
> - At any time, one or all data objects can be exported with latest information
> - Only export data objects that have been populated up to point of export (e.g., if workflow not executed, don't export resulting measurements)
> - **No loading state for MVP/hackathon**

---

## Follow-up Questions (Batch 2)

Based on your answers, I need clarification on a few remaining ambiguities:

### F1. WebSocket Protocol Details
- [ ] What is the **WebSocket endpoint URL** (e.g., `ws://localhost:8000/ws/logs`)?
- [ ] What are the **specific JSON message types** for: agent status, node status, log entries?
- [ ] How does the client **subscribe** to a specific execution (by execution_id)?

### F2. ISA-JSON Confidence Extension
- [ ] ISA-JSON doesn't natively support confidence scores. Should we add a **custom extension** (e.g., `x-confidence` field) to each object?
- [ ] What is the **structure** of confidence metadata: per-Investigation, per-Study, per-Assay, or per-property?

### F3. CWL-to-Frontend Graph Mapping
- [ ] The frontend uses React Flow format (`nodes: [{id, type, data, position}], edges: [{id, source, target}]`). How should CWL Workflows be **transformed** to this format?
- [ ] What determines **node positioning** (auto-layout algorithm, or stored in CWL metadata)?

### F4. MinIO Configuration
- [ ] What is the **bucket structure** for SDS datasets (e.g., `veriflow/{upload_id}/datasets/`)?
- [ ] Should the backend expose **presigned URLs** for file downloads, or use a proxy endpoint?

### F5. Pre-loaded Examples
- [ ] For MAMA-MIA, should the **PDF, extracted ISA, CWL workflow, and sample data** all be pre-loaded in the system?
- [ ] Where should these pre-loaded assets be stored (bundled in backend, or in MinIO on first startup)?

### F6. Agent Session State
- [ ] What is the **session boundary** (per-upload, per-workflow, or global)?
- [ ] How is session state **persisted** between page refreshes (database, in-memory)?
- [ ] What information does each agent's session contain?

---

## Interview Summary

**Questions Asked**: 16 original + 6 follow-ups = 22 total  
**Fully Answered**: 16  
**Pending Follow-ups**: 6  

**Key Decisions Made**:
1. CWL v1.3 for all workflows
2. ISA-JSON for study design serialization
3. Confidence scores: percentage (0-100)
4. Direct Gemini API with session state
5. Airflow 3 local with JWT auth
6. MinIO for all SDS storage
7. WebSocket (JSON) for real-time logs
8. Subject limit: 1 for MVP
9. MAMA-MIA as primary example, Biv-me as stretch goal
10. No workflow state loading for MVP

**Next Steps**:
1. User provides answers to Follow-up Questions (F1-F6)
2. Generate SPEC.md when all critical ambiguities resolved
